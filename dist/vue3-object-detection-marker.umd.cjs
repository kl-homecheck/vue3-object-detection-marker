(function(y,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],a):(y=typeof globalThis<"u"?globalThis:y||self,a(y.Vue3ObjectDetectionMarker={},y.Vue))})(this,function(y,a){"use strict";async function fe(l){return new Promise((o,r)=>{const n=new Image;if(n.crossOrigin="anonymous",n.onload=()=>o(n),n.onerror=r,typeof l=="string")n.src=l;else{const v=URL.createObjectURL(l);n.src=v,n._objectUrl=v}})}function ge(l){l._objectUrl&&(URL.revokeObjectURL(l._objectUrl),delete l._objectUrl)}function H(l,o,r,n,v){const g=Math.floor(n/r),h=Math.floor(v/r),M=Math.floor(l/r),R=Math.floor(o/r);return{row:Math.max(0,Math.min(R,h-1)),col:Math.max(0,Math.min(M,g-1))}}function me(l,o,r){return{x:o*r,y:l*r,width:r,height:r}}function B(l,o){return`${l},${o}`}function we(l){const[o,r]=l.split(",").map(Number);return{row:o,col:r}}function ye(l,o){const r=o.x-l.x,n=o.y-l.y;return Math.sqrt(r*r+n*n)}function pe(l,o){return l.x>=o.x&&l.x<=o.x+o.width&&l.y>=o.y&&l.y<=o.y+o.height}function Ce(l,o,r,n,v){const g=H(l.x,l.y,r,n,v),h=H(o.x,o.y,r,n,v),M=Math.min(g.row,h.row),R=Math.max(g.row,h.row),p=Math.min(g.col,h.col),i=Math.max(g.col,h.col),u=[];for(let d=M;d<=R;d++)for(let w=p;w<=i;w++)u.push({row:d,col:w});return u}function Me(l,o){let r;return function(...v){const g=()=>{clearTimeout(r),l(...v)};clearTimeout(r),r=setTimeout(g,o)}}function be(l,o){let r;return function(...v){r||(l(...v),r=!0,setTimeout(()=>r=!1,o))}}function K(l,o){return o===0?l:K(o,l%o)}function Z(l,o){const r=K(l,o);return{width:l/r,height:o/r}}function ee(l,o){return{cols:l.width*o,rows:l.height*o}}function te(l,o,r,n){return{width:l/r,height:o/n}}function oe(l,o,r,n,v){const g=Z(l,o),h=ee(g,v),M=te(r,n,h.cols,h.rows);return{aspectRatio:g,gridDimensions:h,cellSize:M}}function W(l,o,r,n,v,g){const h=Math.floor(l/r),M=Math.floor(o/n);return{row:Math.max(0,Math.min(M,g-1)),col:Math.max(0,Math.min(h,v-1))}}function Re(l,o,r,n){return{x:o*r,y:l*n,width:r,height:n}}function ke(l,o,r,n,v,g){const h=W(l.x,l.y,r,n,v,g),M=W(o.x,o.y,r,n,v,g),R=Math.min(h.row,M.row),p=Math.max(h.row,M.row),i=Math.min(h.col,M.col),u=Math.max(h.col,M.col),d=[];for(let w=R;w<=p;w++)for(let k=i;k<=u;k++)d.push({row:w,col:k});return d}function q(l,o,r){const n=[],v=new Set;for(let g=0;g<r;g++)for(let h=0;h<o;h++){const M=B(g,h);if(!l.has(M)||v.has(M))continue;let R=1;for(;h+R<o&&l.has(B(g,h+R))&&!v.has(B(g,h+R));)R++;let p=1,i=!0;for(;g+p<r&&i;){for(let u=0;u<R;u++)if(!l.has(B(g+p,h+u))||v.has(B(g+p,h+u))){i=!1;break}i&&p++}for(let u=0;u<p;u++)for(let d=0;d<R;d++)v.add(B(g+u,h+d));n.push({x:h,y:g,width:R,height:p})}return n}const _e={class:"object-detection-marker"},Fe={class:"canvas-container"},Ge=["width","height"],Se={key:0,class:"loading-indicator"},De={key:1,class:"error-message"},Le=a.defineComponent({__name:"ObjectDetectionMarker",props:{image:{},resolution:{default:1},selectionMode:{default:"point"},highlightColor:{default:"#007bff"},gridColor:{default:"#cccccc"},layerColors:{default:()=>["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF"]},canvasWidth:{default:800},canvasHeight:{default:600},hoverColor:{default:"#6c757d"},backgroundColor:{default:"#ffffff"},defaultBrushSize:{default:1},defaultBrushShape:{default:"circle"}},emits:["selectionChange","modeChange","imageLoad","imageError","gridHover","layerChange","activeLayerChange","layerVisibilityChange","layerAdded","layerRemoved"],setup(l,{expose:o,emit:r}){const n=l,v=r,g=a.ref(null),h=a.ref(n.selectionMode||"point"),M=a.ref(""),R=a.ref(!1),p=a.ref(null),i=a.ref(null),u=a.ref(null),d=a.ref(null),w=a.ref(!1),k=a.ref(null),D=a.ref(null),b=a.ref(null),G=a.ref(null),m=a.ref(new Map),F=a.ref(""),L=a.ref(1),T=a.ref("circle"),E=a.computed(()=>n.canvasWidth||800),j=a.computed(()=>n.canvasHeight||600),X=a.computed(()=>g.value?.getContext("2d")||null),x=(e,t)=>{if(!e||!e.startsWith("#"))return`rgba(0, 0, 0, ${t})`;const s=parseInt(e.slice(1,3),16)||0,c=parseInt(e.slice(3,5),16)||0,f=parseInt(e.slice(5,7),16)||0;return`rgba(${s}, ${c}, ${f}, ${t})`},O=e=>({"#FF0000":"빨강","#00FF00":"초록","#0000FF":"파랑","#FFFF00":"노랑","#FF00FF":"마젠타","#00FFFF":"청록"})[e.toUpperCase()]||e,I=()=>{m.value.clear();const e=n.layerColors||[];e.forEach(t=>{m.value.set(t.toUpperCase(),{color:t.toUpperCase(),selectedGrids:new Set,visible:!0,name:O(t),opacity:.5})}),e.length>0&&(F.value=e[0].toUpperCase())},z=e=>{h.value=e,v("modeChange",e),e!=="rectangle"&&(b.value=null,G.value=null),S()},S=()=>{const e=X.value;if(e){if(e.fillStyle=n.backgroundColor,e.fillRect(0,0,E.value,j.value),p.value&&R.value&&e.drawImage(p.value,0,0,E.value,j.value),P(e),A(e),k.value){const t=m.value.get(F.value),s=t?t.color:n.hoverColor;Y(e,k.value,s,.25)}k.value&&(h.value==="point"||h.value==="eraser")&&Be(e),h.value==="rectangle"&&b.value&&G.value&&Ue(e)}},P=e=>{if(d.value){e.strokeStyle=n.gridColor,e.lineWidth=1;for(let t=0;t<=E.value;t+=d.value.width)e.beginPath(),e.moveTo(t,0),e.lineTo(t,j.value),e.stroke();for(let t=0;t<=j.value;t+=d.value.height)e.beginPath(),e.moveTo(0,t),e.lineTo(E.value,t),e.stroke()}},A=e=>{m.value.forEach(t=>{t.visible&&t.selectedGrids.forEach(s=>{const[c,f]=s.split(",").map(Number);Y(e,{row:c,col:f},t.color,t.opacity)})})},Y=(e,t,s,c=.5)=>{if(!d.value)return;const f=t.col*d.value.width,C=t.row*d.value.height;e.fillStyle=x(s,c),e.fillRect(f,C,d.value.width,d.value.height),e.strokeStyle=s,e.lineWidth=2,e.strokeRect(f,C,d.value.width,d.value.height)},Ue=e=>{if(!b.value||!G.value||!d.value)return;const t=Math.min(b.value.col,G.value.col)*d.value.width,s=Math.min(b.value.row,G.value.row)*d.value.height,c=(Math.max(b.value.col,G.value.col)+1)*d.value.width,f=(Math.max(b.value.row,G.value.row)+1)*d.value.height,C=m.value.get(F.value),_=C?C.color:n.highlightColor;e.strokeStyle=_,e.lineWidth=2,e.setLineDash([5,5]),e.strokeRect(t,s,c-t,f-s),e.setLineDash([])},Be=e=>{if(!k.value||!d.value)return;const{row:t,col:s}=k.value,{width:c,height:f}=d.value,C=s*c+c/2,_=t*f+f/2,U=m.value.get(F.value),V=U?U.color:n.highlightColor;if(e.strokeStyle=V,e.lineWidth=2,e.setLineDash([3,3]),T.value==="circle"){const $=(L.value-.5)*Math.min(c,f);e.beginPath(),e.arc(C,_,$,0,Math.PI*2),e.stroke()}else{const $=L.value*2-1,he=$*c,ve=$*f;e.strokeRect(C-he/2,_-ve/2,he,ve)}e.setLineDash([])},re=e=>{e.preventDefault();const t=ce(e.clientX,e.clientY);if(t){if(w.value=!0,h.value==="rectangle")b.value=t,G.value=t;else{const s=h.value==="eraser"?"deselect":"select";J(t,s),D.value=t}N(),S()}},ie=e=>{const t=ce(e.clientX,e.clientY);if((k.value?.row!==t?.row||k.value?.col!==t?.col)&&(k.value=t,v("gridHover",t),S()),!(!w.value||!t))if(h.value==="rectangle")G.value=t,S();else{const s=h.value==="eraser"?"deselect":"select";(!D.value||D.value.row!==t.row||D.value.col!==t.col)&&(J(t,s),D.value=t,N(),S())}},se=()=>{if(w.value){if(w.value=!1,h.value==="rectangle"&&b.value&&G.value){const e=Math.min(b.value.row,G.value.row),t=Math.max(b.value.row,G.value.row),s=Math.min(b.value.col,G.value.col),c=Math.max(b.value.col,G.value.col);for(let f=e;f<=t;f++)for(let C=s;C<=c;C++)J({row:f,col:C},"select");b.value=null,G.value=null,S()}D.value=null}},Oe=()=>{k.value=null,v("gridHover",null),w.value&&(w.value=!1,D.value=null,h.value==="rectangle"&&(b.value=null,G.value=null,S()))},ze=e=>re({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,preventDefault:()=>e.preventDefault()}),$e=e=>ie({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY}),xe=()=>se(),ce=(e,t)=>{const s=g.value?.getBoundingClientRect();if(!s||!d.value||!u.value)return null;const c=e-s.left,f=t-s.top;return W(c,f,d.value.width,d.value.height,u.value.cols,u.value.rows)},J=(e,t="toggle")=>{L.value>1&&t!=="toggle"?Pe(e,t):Q(e,t)},Q=(e,t)=>{const s=B(e.row,e.col),c=m.value.get(F.value);if(!c)return;const f=c.selectedGrids.has(s);switch(t){case"select":f||c.selectedGrids.add(s);break;case"deselect":f&&c.selectedGrids.delete(s);break;case"toggle":f?c.selectedGrids.delete(s):c.selectedGrids.add(s);break}},Pe=(e,t)=>{if(!u.value)return;const{rows:s,cols:c}=u.value,f=L.value;for(let C=e.row-f+1;C<e.row+f;C++)for(let _=e.col-f+1;_<e.col+f;_++)C>=0&&C<s&&_>=0&&_<c&&(T.value==="circle"?Math.sqrt(Math.pow(C-e.row,2)+Math.pow(_-e.col,2))<f&&Q({row:C,col:_},t):Q({row:C,col:_},t))},ue=()=>{if(!p.value)return;const e=oe(p.value.naturalWidth,p.value.naturalHeight,E.value,j.value,n.resolution);i.value=e.aspectRatio,u.value=e.gridDimensions,d.value=e.cellSize},Ae=async e=>{try{M.value="",R.value=!1;const t=new Image;t.crossOrigin="anonymous",await new Promise((s,c)=>{if(t.onload=()=>{p.value=t,ue(),v("imageLoad",t),s()},t.onerror=()=>{M.value="이미지를 불러오는데 실패했습니다.",v("imageError",new Error("Failed to load image")),c(new Error("Failed to load image"))},typeof e=="string")t.src=e;else{const f=URL.createObjectURL(e);t._objectUrl=f,t.src=f}})}catch(t){M.value=t.message}finally{R.value=!0}},Ne=e=>{F.value=e.toUpperCase(),v("activeLayerChange",F.value),S()},Ve=e=>{const t=m.value.get(e.toUpperCase());t&&(t.visible=!t.visible,v("layerVisibilityChange",e.toUpperCase(),t.visible),S())},We=()=>{const e=m.value.get(F.value);return e?e.selectedGrids.size:0},de=()=>Array.from(m.value.values()).reduce((e,t)=>e+(t.visible?t.selectedGrids.size:0),0),Xe=()=>{const e={};return m.value.forEach((t,s)=>{e[s]=Array.from(t.selectedGrids)}),{version:"1.1",imageSize:{width:p.value?.naturalWidth||0,height:p.value?.naturalHeight||0},resolution:n.resolution,layers:e}},Ye=()=>{if(!u.value)return null;const{rows:e,cols:t}=u.value,s={};return m.value.forEach((c,f)=>{s[f]=q(c.selectedGrids,t,e)}),{version:"3.0-grid",metadata:{cols:t,rows:e},layers:s}},He=e=>{if(!e||!e.layers||!u.value)return;const{rows:t,cols:s}=u.value;(e.metadata.cols!==s||e.metadata.rows!==t)&&console.warn("Importing data from a different grid resolution. Results may be inaccurate."),m.value.clear(),Object.entries(e.layers).forEach(([c,f])=>{const C=new Set;f.forEach(U=>{for(let V=U.y;V<U.y+U.height;V++)for(let $=U.x;$<U.x+U.width;$++)C.add(B(V,$))});const _=c.toUpperCase();m.value.set(_,{color:_,selectedGrids:C,visible:!0,name:O(_),opacity:.5})}),m.value.size>0&&(F.value=Array.from(m.value.keys())[0]),S(),N()},Ke=e=>{!e||!e.layers||(m.value.clear(),Object.entries(e.layers).forEach(([t,s])=>{const c=t.toUpperCase();m.value.set(c,{color:c,selectedGrids:new Set(s),visible:!0,name:O(c),opacity:.5})}),m.value.size>0&&(F.value=Array.from(m.value.keys())[0]),S(),N())},qe=()=>{const e={};if(!u.value)return{};const{rows:t,cols:s}=u.value;return m.value.forEach((c,f)=>{if(c.visible&&c.selectedGrids.size>0){const C=q(c.selectedGrids,s,t);e[f]=C.map(_=>({x:_.x/s,y:_.y/t,width:_.width/s,height:_.height/t}))}}),e},N=()=>{const e={activeColor:F.value,layers:Array.from(m.value.values()).map(c=>({color:c.color,selectedCount:c.selectedGrids.size,visible:c.visible,name:c.name})),totalSelected:de()};v("layerChange",e);const t=[];m.value.forEach(c=>{c.visible&&c.selectedGrids.forEach(f=>t.push({row:parseInt(f.split(",")[0]),col:parseInt(f.split(",")[1])}))});const s={selectedCells:t,resolution:n.resolution,imageAspectRatio:i.value||{width:1,height:1},gridDimensions:u.value||{cols:1,rows:1},cellSize:d.value||{width:1,height:1},imageWidth:p.value?.naturalWidth||0,imageHeight:p.value?.naturalHeight||0,canvasWidth:E.value,canvasHeight:j.value,layerData:e};v("selectionChange",s)};return a.watch(()=>n.image,e=>{e&&Ae(e)},{immediate:!0}),a.watch(()=>n.selectionMode,e=>{e&&z(e)}),a.watch(()=>n.resolution,()=>{I(),ue(),N(),S()}),a.watch(()=>n.layerColors,()=>{I(),S()},{deep:!0}),o({exportGridLayers:Xe,importGridLayers:Ke,getSelectionAsPercentRects:qe,exportOptimizedLayers:Ye,importOptimizedLayers:He,switchMode:z,setActiveColorLayer:Ne,toggleLayerVisibility:Ve,getColorLayers:()=>m,getActiveColorLayer:()=>F.value,getCurrentMode:()=>h.value,getBrushSize:()=>L.value,setBrushSize:e=>{L.value=e},getBrushShape:()=>T.value,setBrushShape:e=>{T.value=e},getTotalSelectedCount:de,getActiveLayerCount:We,getColorName:O}),a.onMounted(()=>{I(),L.value=n.defaultBrushSize,T.value=n.defaultBrushShape,g.value&&S()}),a.onUnmounted(()=>{p.value&&p.value._objectUrl&&URL.revokeObjectURL(p.value._objectUrl)}),(e,t)=>(a.openBlock(),a.createElementBlock("div",_e,[a.createElementVNode("div",Fe,[a.createElementVNode("canvas",{ref_key:"canvasRef",ref:g,class:"marker-canvas",width:E.value,height:j.value,onMousedown:re,onMousemove:ie,onMouseup:se,onMouseleave:Oe,onTouchstart:a.withModifiers(ze,["prevent"]),onTouchmove:a.withModifiers($e,["prevent"]),onTouchend:a.withModifiers(xe,["prevent"])},null,40,Ge),!R.value&&n.image?(a.openBlock(),a.createElementBlock("div",Se," 이미지를 로딩 중... ")):a.createCommentVNode("",!0),M.value?(a.openBlock(),a.createElementBlock("div",De,a.toDisplayString(M.value),1)):a.createCommentVNode("",!0)])]))}}),ae=(l,o)=>{const r=l.__vccOpts||l;for(const[n,v]of o)r[n]=v;return r},le=ae(Le,[["__scopeId","data-v-d93b913e"]]),Ee={class:"object-detection-preview"},je={key:0,class:"skeleton-container"},Ie={key:1,class:"error-message"},ne=ae(a.defineComponent({__name:"ObjectDetectionPreview",props:{image:{},selectionData:{},canvasWidth:{},canvasHeight:{},backgroundColor:{},layerColors:{},objectFitMode:{},renderMode:{}},setup(l){const o=l,r=a.ref(null),n=a.ref(!1),v=a.ref(""),g=a.computed(()=>o.objectFitMode||"contain"),h=a.computed(()=>o.renderMode||"grid"),M=i=>{if(i.length===0)return null;let u=1/0,d=1/0,w=-1/0,k=-1/0;return i.forEach(D=>{u=Math.min(u,D.x),d=Math.min(d,D.y),w=Math.max(w,D.x+D.width),k=Math.max(k,D.y+D.height)}),{x:u,y:d,width:w-u,height:k-d}},R=async()=>{const i=r.value,u=i?.getContext("2d");if(!u||!o.image||!i)return;const d=i.getBoundingClientRect();i.width=d.width,i.height=d.height,n.value=!1,v.value="";try{const w=new Image;w.crossOrigin="anonymous",await new Promise((k,D)=>{w.onload=()=>{if(!i)return;u.clearRect(0,0,i.width,i.height);const b=w.width/w.height,G=i.width/i.height;let m,F,L,T;if(g.value==="contain"?b>G?(m=i.width,F=i.width/b,L=0,T=(i.height-F)/2):(F=i.height,m=i.height*b,L=(i.width-m)/2,T=0):b>G?(F=i.height,m=i.height*b,L=(i.width-m)/2,T=0):(m=i.width,F=i.width/b,L=0,T=(i.height-F)/2),u.drawImage(w,L,T,m,F),o.selectionData&&o.selectionData.layers){const{cols:E,rows:j}=o.selectionData.metadata;if(E===0||j===0)return;Object.entries(o.selectionData.layers).forEach(([X,x])=>{if(x.length===0)return;const O=o.layerColors?.[X]||{color:X,opacity:.5};if(h.value==="rect"){const I=M(x);if(!I)return;const z=I.x/E*i.width,S=I.y/j*i.height,P=I.width/E*i.width,A=I.height/j*i.height;u.fillStyle=p(O.color,O.opacity),u.fillRect(z,S,P,A)}else{const I=new Path2D;x.forEach(z=>{const S=z.x/E*i.width,P=z.y/j*i.height,A=z.width/E*i.width,Y=z.height/j*i.height;I.rect(S,P,A,Y)}),u.fillStyle=p(O.color,O.opacity),u.fill(I)}})}k()},w.onerror=()=>D(new Error("이미지를 불러올 수 없습니다.")),typeof o.image=="string"?w.src=o.image:w.src=URL.createObjectURL(o.image)})}catch(w){v.value=w.message}finally{n.value=!0}},p=(i,u)=>{if(!i||!i.startsWith("#"))return`rgba(0, 0, 0, ${u})`;const d=parseInt(i.slice(1,3),16)||0,w=parseInt(i.slice(3,5),16)||0,k=parseInt(i.slice(5,7),16)||0;return`rgba(${d}, ${w}, ${k}, ${u})`};return a.watch(()=>[o.image,o.selectionData],R,{deep:!0}),a.onMounted(()=>{R()}),(i,u)=>(a.openBlock(),a.createElementBlock("div",Ee,[!n.value&&!v.value?(a.openBlock(),a.createElementBlock("div",je,u[0]||(u[0]=[a.createElementVNode("div",{class:"skeleton-shimmer"},null,-1),a.createElementVNode("div",{class:"skeleton-text"},"미리보기 로딩 중...",-1)]))):a.createCommentVNode("",!0),a.createElementVNode("canvas",{ref_key:"previewCanvasRef",ref:r,class:a.normalizeClass(["preview-canvas",{"canvas-loaded":n.value,"fit-contain":g.value==="contain","fit-cover":g.value==="cover"}])},null,2),v.value?(a.openBlock(),a.createElementBlock("div",Ie,a.toDisplayString(v.value),1)):a.createCommentVNode("",!0)]))}}),[["__scopeId","data-v-6f1cf08a"]]),Te={install(l){l.component("ObjectDetectionMarker",le),l.component("ObjectDetectionPreview",ne)}};y.ObjectDetectionMarker=le,y.ObjectDetectionPreview=ne,y.calculateAspectRatio=Z,y.calculateCellSize=te,y.calculateGridDimensions=ee,y.calculateGridFromResolution=oe,y.cleanupImage=ge,y.debounce=Me,y.default=Te,y.gcd=K,y.getDistance=ye,y.getGridCellsInRectangle=Ce,y.getGridCellsInRectangleResolution=ke,y.getGridKey=B,y.gridToScreen=me,y.gridToScreenResolution=Re,y.isPointInRectangle=pe,y.loadImage=fe,y.mergeGridsToRects=q,y.parseGridKey=we,y.screenToGrid=H,y.screenToGridResolution=W,y.throttle=be,Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
